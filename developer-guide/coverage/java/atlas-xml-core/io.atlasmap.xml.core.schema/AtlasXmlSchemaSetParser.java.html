<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AtlasXmlSchemaSetParser.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Coverage Report</a> &gt; <a href="../index.html" class="el_bundle">atlas-xml-core</a> &gt; <a href="index.source.html" class="el_package">io.atlasmap.xml.core.schema</a> &gt; <span class="el_source">AtlasXmlSchemaSetParser.java</span></div><h1>AtlasXmlSchemaSetParser.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2017 Red Hat, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.atlasmap.xml.core.schema;

import static io.atlasmap.xml.core.AtlasXmlConstants.NS_PREFIX_SCHEMASET;
import static io.atlasmap.xml.core.AtlasXmlConstants.NS_PREFIX_XMLSCHEMA;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.util.LinkedList;
import java.util.List;

import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.SAXParserFactory;
import javax.xml.transform.Source;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import javax.xml.validation.Schema;
import javax.xml.validation.SchemaFactory;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathFactory;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.ErrorHandler;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;

import com.sun.xml.xsom.XSSchemaSet;
import com.sun.xml.xsom.parser.XSOMParser;
import com.sun.xml.xsom.util.DomAnnotationParserFactory;

import io.atlasmap.api.AtlasException;
import io.atlasmap.xml.core.AtlasXmlNamespaceContext;

/**
 * The XML schema parser which parses a single XML Schema or SchemaSet XML
 * which contains multipe XML schema and build a XSOM {@link XSSchemaSet}.
 */
public class AtlasXmlSchemaSetParser {

<span class="fc" id="L67">    private static final Logger LOG = LoggerFactory.getLogger(AtlasXmlSchemaSetParser.class);</span>
    private ClassLoader classLoader;
    private AtlasXmlNamespaceContext namespaceContext;
    private String rootNamespace;
    private SAXParserFactory saxParserFactory;
    private Transformer transformer;
    private DocumentBuilder documentBuilder;

    /**
     * A constructor.
     * @param cl class loader
     * @throws AtlasException unexpected error
     */
<span class="fc" id="L80">    public AtlasXmlSchemaSetParser(ClassLoader cl) throws AtlasException {</span>
<span class="fc" id="L81">        this.classLoader = cl;</span>
<span class="fc" id="L82">        this.namespaceContext = new AtlasXmlNamespaceContext();</span>
<span class="fc" id="L83">        this.saxParserFactory = SAXParserFactory.newInstance();</span>
        try {
<span class="fc" id="L85">            this.transformer = TransformerFactory.newInstance().newTransformer();</span>
<span class="fc" id="L86">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L87">            dbf.setNamespaceAware(true);</span>
<span class="fc" id="L88">            this.documentBuilder = dbf.newDocumentBuilder();</span>
<span class="nc" id="L89">        } catch (Exception e) {</span>
<span class="nc" id="L90">            throw new AtlasException(e);</span>
<span class="fc" id="L91">        }</span>
<span class="fc" id="L92">    }</span>

    /**
     * Parse single XML Schema or SchemaSet which contains multiple XML Schema and
     * build a XSOM {@link XSSchemaSet}.
     * @param doc DOM {@link Document} instance of XML Schema
     * @return parsed {@link XSSchemaSet}
     * @throws AtlasException If it fails to parse
     */
    public XSSchemaSet parse(Document doc) throws AtlasException {
<span class="fc" id="L102">        XSOMParser xsomParser = createXSOMParser();</span>
<span class="fc" id="L103">        parseInternal(doc, n -&gt; {</span>
            try {
<span class="fc" id="L105">                xsomParser.parse(toInputStream(n));</span>
<span class="fc" id="L106">            } catch (Exception e) {</span>
<span class="fc" id="L107">                throw new AtlasException(e);</span>
<span class="fc" id="L108">            }</span>
<span class="fc" id="L109">        });</span>
        try {
<span class="fc" id="L111">            return xsomParser.getResult();</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            throw new AtlasException(e);</span>
        }
    }

    /**
     * Parse XML Schema or SchemaSet which contains multiple XML Schema and
     * build a {@link XSSchemaSet}.
     * @param in {@link InputStream} of XML Schema document
     * @return parsed {@link XSSchemaSet}
     * @throws AtlasException If it fails to parse
     */
    public XSSchemaSet parse(InputStream in) throws AtlasException {
        try {
<span class="fc" id="L126">            Document doc = this.documentBuilder.parse(in);</span>
<span class="fc" id="L127">            return parse(doc);</span>
<span class="fc" id="L128">        } catch (Exception e) {</span>
<span class="fc" id="L129">            throw new AtlasException(e);</span>
        }
    }

    /**
     * Parse single XML Schema or SchemaSet which contains multiple XML Schema and
     * build a {@link Schema}.
     * @param in {@link InputStream} to read schema contents from
     * @return Created {@link Schema}
     * @throws AtlasException If it fails to parse
     */
    public Schema createSchema(InputStream in) throws AtlasException {
<span class="fc" id="L141">        SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</span>
<span class="fc" id="L142">        List&lt;Source&gt; schemaSources = new LinkedList&lt;&gt;();</span>
        Document doc;
        try {
<span class="fc" id="L145">            doc = this.documentBuilder.parse(in);</span>
<span class="fc" id="L146">            parseInternal(doc, n -&gt; {</span>
<span class="fc" id="L147">                DOMSource s = new DOMSource(n);</span>
<span class="fc" id="L148">                schemaSources.add(s);</span>
<span class="fc" id="L149">            });</span>
<span class="fc" id="L150">            factory.setErrorHandler(new NoopErrorHandler());</span>
<span class="fc" id="L151">            return factory.newSchema(schemaSources.toArray(new Source[0]));</span>
<span class="nc" id="L152">        } catch (AtlasException e) {</span>
<span class="nc" id="L153">            throw e;</span>
<span class="nc" id="L154">        } catch (Exception e2) {</span>
<span class="nc" id="L155">            throw new AtlasException(e2);</span>
        }
    }

    /**
     * Sets the namespace context.
     * @param nsc namespace context
     */
    public void setNamespaceContext(AtlasXmlNamespaceContext nsc) {
<span class="nc" id="L164">        this.namespaceContext = nsc;</span>
<span class="nc" id="L165">    }</span>

    /**
     * Gets the namespace context.
     * @return namespace context
     */
    public AtlasXmlNamespaceContext getNamespaceContext() {
<span class="fc" id="L172">        return this.namespaceContext;</span>
    }

    /**
     * Sets the root namespace.
     * @param rootns root namespace
     */
    public void setRootNamespace(String rootns) {
<span class="nc" id="L180">        this.rootNamespace = rootns;</span>
<span class="nc" id="L181">    }</span>

    /**
     * Gets the root namespace.
     * @return root namespace
     */
    public String getRootNamespace() {
<span class="fc" id="L188">        return this.rootNamespace;</span>
    }

    /**
     * Gets the target namespace.
     * @param n node
     * @return target namespace
     */
    private String getTargetNamespace(Node n) {
<span class="fc" id="L197">        NamedNodeMap attributes = n.getAttributes();</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">        if (attributes == null) {</span>
<span class="nc" id="L199">            return &quot;&quot;;</span>
        }
<span class="fc" id="L201">        Attr tns = (Attr) attributes.getNamedItem(&quot;targetNamespace&quot;);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">        return tns != null ? tns.getValue() : &quot;&quot;;</span>
    }

    @FunctionalInterface
    private interface ParserCallback {
        void addSchema(Node n) throws AtlasException;
    }

<span class="fc" id="L210">    private class NoopErrorHandler implements ErrorHandler {</span>

        @Override
        public void warning(SAXParseException e) throws SAXException {
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L215">                LOG.debug(&quot;warning&quot;, e);</span>
            }
<span class="nc" id="L217">        }</span>

        @Override
        public void error(SAXParseException e) throws SAXException {
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L222">                LOG.debug(&quot;error&quot;, e);</span>
            }
<span class="fc" id="L224">        }</span>

        @Override
        public void fatalError(SAXParseException e) throws SAXException {
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L229">                LOG.debug(&quot;fatalError&quot;, e);</span>
            }
<span class="nc" id="L231">        }</span>
        
    }

    private void parseInternal(Document doc, ParserCallback callback) throws AtlasException {
        try {
<span class="fc" id="L237">            Element root = doc.getDocumentElement();</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (&quot;SchemaSet&quot;.equals(root.getLocalName())) {</span>
<span class="fc" id="L239">                XPath xpath = XPathFactory.newInstance().newXPath();</span>
<span class="fc" id="L240">                xpath.setNamespaceContext(this.namespaceContext);</span>
<span class="fc" id="L241">                NodeList subSchemas = (NodeList) xpath</span>
<span class="fc" id="L242">                        .evaluate(String.format(&quot;/%s:SchemaSet/%s:AdditionalSchemas/%s:schema&quot;, NS_PREFIX_SCHEMASET,</span>
                                NS_PREFIX_SCHEMASET, NS_PREFIX_XMLSCHEMA), root, XPathConstants.NODESET);
<span class="fc bfc" id="L244" title="All 2 branches covered.">                for (int i = 0; i &lt; subSchemas.getLength(); i++) {</span>
<span class="fc" id="L245">                    Element e = (Element) subSchemas.item(i);</span>
<span class="fc" id="L246">                    inheritNamespaces(e, false);</span>
<span class="fc" id="L247">                    callback.addSchema(e);</span>
                }

<span class="fc" id="L250">                Element rootSchema = (Element) xpath.evaluate(</span>
<span class="fc" id="L251">                        String.format(&quot;/%s:SchemaSet/%s:schema&quot;, NS_PREFIX_SCHEMASET, NS_PREFIX_XMLSCHEMA), root,</span>
                        XPathConstants.NODE);
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">                if (rootSchema == null) {</span>
<span class="nc" id="L254">                    throw new AtlasException(</span>
                            &quot;The root schema '/SchemaSet/schema' must be specified once and only once&quot;);
                }
<span class="fc" id="L257">                this.rootNamespace = getTargetNamespace(rootSchema);</span>
<span class="pc bpc" id="L258" title="1 of 4 branches missed.">                if (this.rootNamespace != null &amp;&amp; !this.rootNamespace.isEmpty()) {</span>
<span class="fc" id="L259">                    this.namespaceContext.add(&quot;tns&quot;, this.rootNamespace);</span>
                }
<span class="fc" id="L261">                inheritNamespaces(rootSchema, true);</span>
<span class="fc" id="L262">                callback.addSchema(rootSchema);</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">            } else if (&quot;schema&quot;.equals(root.getLocalName())) {</span>
<span class="fc" id="L264">                callback.addSchema(root);</span>
<span class="fc" id="L265">                this.rootNamespace = getTargetNamespace(root);</span>
<span class="pc bpc" id="L266" title="1 of 4 branches missed.">                if (this.rootNamespace != null &amp;&amp; !this.rootNamespace.isEmpty()) {</span>
<span class="fc" id="L267">                    this.namespaceContext.add(&quot;tns&quot;, this.rootNamespace);</span>
                }
            } else {
<span class="nc" id="L270">                throw new AtlasException(</span>
<span class="nc" id="L271">                        String.format(&quot;Unsupported document element '%s': root element must be 'schema' or 'SchemaSet'&quot;,</span>
<span class="nc" id="L272">                                root.getLocalName()));</span>
            }
<span class="fc" id="L274">        } catch (Exception e) {</span>
<span class="fc" id="L275">            throw new AtlasException(e);</span>
<span class="fc" id="L276">        }</span>
<span class="fc" id="L277">    }</span>

    private XSOMParser createXSOMParser() {
<span class="fc" id="L280">        XSOMParser parser = new XSOMParser(this.saxParserFactory);</span>
<span class="fc" id="L281">        parser.setEntityResolver(new XSOMClasspathEntityResolver(this.classLoader));</span>
<span class="fc" id="L282">        parser.setAnnotationParser(new DomAnnotationParserFactory());</span>
<span class="fc" id="L283">        parser.setErrorHandler(new XSOMErrorHandler());</span>
<span class="fc" id="L284">        return parser;</span>
    }

    private void inheritNamespaces(Element element, boolean updateContext) {
<span class="fc" id="L288">        Node target = element.getParentNode();</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        while (target != null) {</span>
<span class="fc" id="L290">            NamedNodeMap attributes = target.getAttributes();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            if (attributes != null) {</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">                for (int i = 0; i &lt; attributes.getLength(); i++) {</span>
<span class="fc" id="L293">                    Attr attr = (Attr) attributes.item(i);</span>
<span class="pc bpc" id="L294" title="2 of 4 branches missed.">                    if (&quot;xmlns&quot;.equals(attr.getPrefix()) &amp;&amp; !&quot;xmlns&quot;.equals(attr.getLocalName())) {</span>
<span class="fc" id="L295">                        element.setAttribute(attr.getName(), attr.getValue());</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                        if (updateContext) {</span>
<span class="fc" id="L297">                            namespaceContext.add(attr.getLocalName(), attr.getValue());</span>
                        }
                    }
                }
            }
<span class="fc" id="L302">            target = target.getParentNode();</span>
<span class="fc" id="L303">        }</span>
<span class="fc" id="L304">    }</span>

    private ByteArrayInputStream toInputStream(Node n) throws Exception {
<span class="fc" id="L307">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L308">        this.transformer.transform(new DOMSource(n), new StreamResult(baos));</span>
<span class="fc" id="L309">        byte[] output = baos.toByteArray();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">        if (LOG.isTraceEnabled()) {</span>
<span class="fc" id="L311">            LOG.trace(&quot;&gt;&gt;&gt; {}&quot;, new String(output));</span>
        }
<span class="fc" id="L313">        return new ByteArrayInputStream(output);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>