<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AtlasMapSMT.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Coverage Report</a> &gt; <a href="../index.html" class="el_bundle">atlasmap-kafka-smt</a> &gt; <a href="index.source.html" class="el_package">io.atlasmap.kafka.smt</a> &gt; <span class="el_source">AtlasMapSMT.java</span></div><h1>AtlasMapSMT.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2017 Red Hat, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.atlasmap.kafka.smt;

import java.io.File;
import java.util.Map;

import org.apache.kafka.common.config.ConfigDef;
import org.apache.kafka.connect.connector.ConnectRecord;
import org.apache.kafka.connect.transforms.Transformation;
import org.apache.kafka.connect.transforms.util.SimpleConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import io.atlasmap.api.AtlasSession;
import io.atlasmap.core.DefaultAtlasContext;
import io.atlasmap.core.DefaultAtlasContextFactory;

/**
 * Kafka Connect Single Message Transformation that uses AtlasMap to transform.
 * This maps from 2 source Documents which are key and value, to the
 * 2 target Documents (key and value). Not only the Kafka Connect data structure
 * defined with the Kafka Connect schema, the Document could be also a serialized
 * data format that is supported by AtlasMap, such as JSON or XML.
 * @param &lt;R&gt; ConnectRecord type
 */
<span class="fc" id="L40">public class AtlasMapSMT&lt;R extends ConnectRecord&lt;R&gt;&gt; implements Transformation&lt;R&gt; {</span>
    /** Overview. */
    public static final String OVERVIEW_DOC = &quot;Process AtlasMap data mapping with a Kafka Connect record&quot;;

    private interface ConfigName {
        String ADM_PATH = &quot;adm.path&quot;;
        String DOCID_SOURCE_KEY = &quot;docid.source.key&quot;;
        String DOCID_SOURCE_VALUE = &quot;docid.source.value&quot;;
        String DOCID_TARGET_KEY = &quot;docid.target.key&quot;;
        String DOCID_TARGET_VALUE = &quot;docid.target.value&quot;;
    }

    /** Config Def. */
<span class="fc" id="L53">    public static final ConfigDef CONFIG_DEF = new ConfigDef()</span>
<span class="fc" id="L54">        .define(ConfigName.ADM_PATH, ConfigDef.Type.STRING, &quot;&quot;, ConfigDef.Importance.HIGH, &quot;Path for the ADM file&quot;)</span>
<span class="fc" id="L55">        .define(ConfigName.DOCID_SOURCE_KEY, ConfigDef.Type.STRING, &quot;&quot;, ConfigDef.Importance.MEDIUM, &quot;Document ID for the source key&quot;)</span>
<span class="fc" id="L56">        .define(ConfigName.DOCID_SOURCE_VALUE, ConfigDef.Type.STRING, &quot;&quot;, ConfigDef.Importance.MEDIUM, &quot;Document ID for the source value&quot;)</span>
<span class="fc" id="L57">        .define(ConfigName.DOCID_TARGET_KEY, ConfigDef.Type.STRING, &quot;&quot;, ConfigDef.Importance.MEDIUM, &quot;Document ID for the target key&quot;)</span>
<span class="fc" id="L58">        .define(ConfigName.DOCID_TARGET_VALUE, ConfigDef.Type.STRING, &quot;&quot;, ConfigDef.Importance.MEDIUM, &quot;Document ID for the target value&quot;);</span>

<span class="fc" id="L60">    private static final Logger LOG = LoggerFactory.getLogger(AtlasMapSMT.class);</span>

    private String admPath;
    private String docIdSourceKey;
    private String docIdSourceValue;
    private String docIdTargetKey;
    private String docIdTargetValue;
    private DefaultAtlasContext atlasContext;

    @Override
    public void configure(Map&lt;String, ?&gt; props) {
<span class="fc" id="L71">        final SimpleConfig config = new SimpleConfig(CONFIG_DEF, props);</span>
<span class="fc" id="L72">        admPath = config.getString(ConfigName.ADM_PATH);</span>
<span class="fc" id="L73">        docIdSourceKey = config.getString(ConfigName.DOCID_SOURCE_KEY);</span>
<span class="fc" id="L74">        docIdSourceValue = config.getString(ConfigName.DOCID_SOURCE_VALUE);</span>
<span class="fc" id="L75">        docIdTargetKey = config.getString(ConfigName.DOCID_TARGET_KEY);</span>
<span class="fc" id="L76">        docIdTargetValue = config.getString(ConfigName.DOCID_TARGET_VALUE);</span>

        try {
<span class="fc" id="L79">            atlasContext = DefaultAtlasContextFactory.getInstance().createContext(new File(admPath));</span>
<span class="nc" id="L80">        } catch (Exception e) {</span>
<span class="nc" id="L81">            LOG.error(&quot;Could not load ADM archive file: {}&quot;, e.getMessage());</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L83">                LOG.error(&quot;&quot;, e);</span>
            }
<span class="fc" id="L85">        }</span>
<span class="fc" id="L86">    }</span>

    @Override
    public R apply(R record) {
        try {
<span class="fc" id="L91">            AtlasSession session = atlasContext.createSession();</span>
<span class="pc bpc" id="L92" title="2 of 4 branches missed.">            if (docIdSourceKey != null &amp;&amp; !docIdSourceKey.isEmpty()) {</span>
<span class="nc" id="L93">                session.setSourceDocument(docIdSourceKey, record.key());</span>
            }
<span class="pc bpc" id="L95" title="2 of 4 branches missed.">            if (docIdSourceValue != null &amp;&amp; !docIdSourceValue.isEmpty()) {</span>
<span class="fc" id="L96">                session.setSourceDocument(docIdSourceValue, record.value());</span>
            } else {
<span class="nc" id="L98">                session.setDefaultSourceDocument(record.value());</span>
            }
<span class="fc" id="L100">            atlasContext.process(session);</span>
<span class="fc" id="L101">            Object outKey = null, outValue = null;</span>
<span class="pc bpc" id="L102" title="2 of 4 branches missed.">            if (docIdTargetKey != null &amp;&amp; !docIdTargetKey.isEmpty()) {</span>
<span class="nc" id="L103">                outKey = session.getTargetDocument(docIdTargetKey);</span>
            }
<span class="pc bpc" id="L105" title="2 of 4 branches missed.">            if (docIdTargetValue != null &amp;&amp; !docIdTargetValue.isEmpty()) {</span>
<span class="fc" id="L106">                outValue = session.getTargetDocument(docIdTargetValue);</span>
            } else {
<span class="nc" id="L108">                outValue = session.getDefaultTargetDocument();</span>
            }
<span class="fc" id="L110">            return record.newRecord(record.topic(), record.kafkaPartition(),</span>
<span class="fc" id="L111">                null, outKey, null, outValue, record.timestamp());</span>
<span class="nc" id="L112">        } catch (Exception e) {</span>
<span class="nc" id="L113">            LOG.error(&quot;Could not process AtlasMap mapping: {}&quot;, e.getMessage());</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L115">                LOG.error(&quot;&quot;, e);</span>
            }
<span class="nc" id="L117">            return record;</span>
        }
    }

    @Override
    public ConfigDef config() {
<span class="fc" id="L123">        return CONFIG_DEF;</span>
    }

    @Override
    public void close() {
<span class="fc" id="L128">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>