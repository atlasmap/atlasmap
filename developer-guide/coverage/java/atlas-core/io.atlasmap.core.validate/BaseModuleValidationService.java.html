<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BaseModuleValidationService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Coverage Report</a> &gt; <a href="../index.html" class="el_bundle">atlas-core</a> &gt; <a href="index.source.html" class="el_package">io.atlasmap.core.validate</a> &gt; <span class="el_source">BaseModuleValidationService.java</span></div><h1>BaseModuleValidationService.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2017 Red Hat, Inc.
 * &lt;p&gt;
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * &lt;p&gt;
 * http://www.apache.org/licenses/LICENSE-2.0
 * &lt;p&gt;
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.atlasmap.core.validate;

import java.util.ArrayList;
import java.util.List;

import io.atlasmap.api.AtlasValidationService;
import io.atlasmap.core.DefaultAtlasCollectionHelper;
import io.atlasmap.core.DefaultAtlasConversionService;
import io.atlasmap.core.DefaultAtlasFieldActionService;
import io.atlasmap.spi.AtlasConversionService;
import io.atlasmap.spi.AtlasFieldActionService;
import io.atlasmap.spi.AtlasModuleDetail;
import io.atlasmap.spi.AtlasModuleMode;
import io.atlasmap.spi.FieldDirection;
import io.atlasmap.v2.AtlasMapping;
import io.atlasmap.v2.BaseMapping;
import io.atlasmap.v2.CustomMapping;
import io.atlasmap.v2.DataSource;
import io.atlasmap.v2.Field;
import io.atlasmap.v2.FieldGroup;
import io.atlasmap.v2.FieldType;
import io.atlasmap.v2.Mapping;
import io.atlasmap.v2.MappingType;
import io.atlasmap.v2.Validation;
import io.atlasmap.v2.ValidationScope;
import io.atlasmap.v2.ValidationStatus;

public abstract class BaseModuleValidationService&lt;T extends Field&gt; implements AtlasValidationService {

    private AtlasConversionService conversionService;
    private AtlasFieldActionService fieldActionService;
    private DefaultAtlasCollectionHelper collectionHelper;
    private AtlasModuleMode mode;
    private String docId;
    private MappingFieldPairValidator mappingFieldPairValidator;

<span class="nc" id="L52">    public BaseModuleValidationService() {</span>
<span class="nc" id="L53">        this.conversionService = DefaultAtlasConversionService.getInstance();</span>
<span class="nc" id="L54">        this.fieldActionService = DefaultAtlasFieldActionService.getInstance();</span>
<span class="nc" id="L55">        this.collectionHelper = new DefaultAtlasCollectionHelper(this.fieldActionService);</span>
<span class="nc" id="L56">        init();</span>
<span class="nc" id="L57">    }</span>

<span class="fc" id="L59">    public BaseModuleValidationService(AtlasConversionService conversionService, AtlasFieldActionService fieldActionService) {</span>
<span class="fc" id="L60">        this.conversionService = conversionService;</span>
<span class="fc" id="L61">        this.fieldActionService = fieldActionService;</span>
<span class="fc" id="L62">        this.collectionHelper = new DefaultAtlasCollectionHelper(fieldActionService);</span>
<span class="fc" id="L63">        init();</span>
<span class="fc" id="L64">    }</span>

    private void init() {
<span class="fc" id="L67">        this.mappingFieldPairValidator = new MappingFieldPairValidator(this);</span>
<span class="fc" id="L68">    }</span>

    public void setMode(AtlasModuleMode mode) {
<span class="fc" id="L71">        this.mode = mode;</span>
<span class="fc" id="L72">    }</span>

    public AtlasModuleMode getMode() {
<span class="fc" id="L75">        return mode;</span>
    }

    public void setDocId(String docId) {
<span class="fc" id="L79">        this.docId = docId;</span>
<span class="fc" id="L80">    }</span>

    public String getDocId() {
<span class="fc" id="L83">        return this.docId;</span>
    }

    protected abstract AtlasModuleDetail getModuleDetail();

    @Override
    public List&lt;Validation&gt; validateMapping(AtlasMapping mapping) {
<span class="fc" id="L90">        List&lt;Validation&gt; validations = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        if (getMode() == AtlasModuleMode.UNSET) {</span>
<span class="nc" id="L92">            Validation validation = new Validation();</span>
<span class="nc" id="L93">            validation.setMessage(String.format(</span>
                    &quot;No mode specified for %s/%s, skipping module validations&quot;,
<span class="nc" id="L95">                    this.getModuleDetail().name(), this.getClass().getSimpleName()));</span>
        }

<span class="pc bpc" id="L98" title="3 of 6 branches missed.">        if (mapping != null &amp;&amp; mapping.getMappings() != null &amp;&amp; mapping.getMappings().getMapping() != null</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                &amp;&amp; !mapping.getMappings().getMapping().isEmpty()) {</span>
<span class="fc" id="L100">            validateMappingEntries(mapping.getMappings().getMapping(), validations);</span>
        }

<span class="fc" id="L103">        boolean found = false;</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">        for (DataSource ds : mapping.getDataSource()) {</span>
<span class="pc bpc" id="L105" title="1 of 4 branches missed.">            if (ds.getUri() != null &amp;&amp; ds.getUri().startsWith(getModuleDetail().uri())) {</span>
<span class="fc" id="L106">                found = true;</span>
<span class="fc" id="L107">                break;</span>
            }
<span class="fc" id="L109">        }</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (!found) {</span>
<span class="fc" id="L112">            Validation validation = new Validation();</span>
<span class="fc" id="L113">            validation.setScope(ValidationScope.DATA_SOURCE);</span>
<span class="fc" id="L114">            validation.setMessage(String.format(&quot;No DataSource with '%s' uri specified&quot;, getModuleDetail().uri()));</span>
<span class="fc" id="L115">            validation.setStatus(ValidationStatus.ERROR);</span>
<span class="fc" id="L116">            validations.add(validation);</span>
        }

<span class="fc" id="L119">        return validations;</span>
    }

    protected void validateMappingEntries(List&lt;BaseMapping&gt; mappings, List&lt;Validation&gt; validations) {
<span class="fc bfc" id="L123" title="All 2 branches covered.">        for (BaseMapping fieldMapping : mappings) {</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            if (fieldMapping.getClass().isAssignableFrom(CustomMapping.class)) {</span>
<span class="fc" id="L125">                validateCustomMapping((CustomMapping)fieldMapping, validations);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">            } else if (fieldMapping.getClass().isAssignableFrom(Mapping.class)</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">                    &amp;&amp; MappingType.SEPARATE.equals(((Mapping) fieldMapping).getMappingType())) {</span>
<span class="fc" id="L128">                validateSeparateMapping((Mapping) fieldMapping, validations);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">            } else if (fieldMapping.getClass().isAssignableFrom(Mapping.class)</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                    &amp;&amp; MappingType.COMBINE.equals(((Mapping) fieldMapping).getMappingType())) {</span>
<span class="fc" id="L131">                validateCombineMapping((Mapping) fieldMapping, validations);</span>
            } else {
<span class="fc bfc" id="L133" title="All 2 branches covered.">                if (fieldMapping instanceof io.atlasmap.v2.Collection) {</span>
<span class="fc" id="L134">                    fieldMapping = ((io.atlasmap.v2.Collection)fieldMapping).getMappings().getMapping().get(0);</span>
                }
<span class="fc" id="L136">                validateMapMapping((Mapping) fieldMapping, validations);</span>
            }
<span class="fc" id="L138">        }</span>
<span class="fc" id="L139">    }</span>

    protected void validateMapMapping(Mapping mapping, List&lt;Validation&gt; validations) {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (mapping == null</span>
<span class="pc bpc" id="L143" title="2 of 6 branches missed.">                || mapping.getInputField() == null || (mapping.getInputFieldGroup() == null &amp;&amp; mapping.getInputField().size() &lt;= 0)</span>
<span class="pc bpc" id="L144" title="2 of 4 branches missed.">                || mapping.getOutputField() == null || mapping.getOutputField().size() &lt;= 0) {</span>
<span class="nc" id="L145">            return;</span>
        }
<span class="fc" id="L147">        String mappingId = mapping.getId();</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (getMode() == AtlasModuleMode.SOURCE) {</span>
<span class="fc" id="L150">            FieldGroup sourceFieldGroup = mapping.getInputFieldGroup();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            if (sourceFieldGroup != null) {</span>
<span class="fc" id="L152">                validateFieldGroup(mappingId, sourceFieldGroup, FieldDirection.SOURCE, validations);</span>
            } else {
<span class="fc" id="L154">                List&lt;Field&gt; sourceFields = mapping.getInputField();</span>
<span class="fc" id="L155">                sourceFields.forEach(sourceField -&gt; {</span>
<span class="fc" id="L156">                    validateField(mappingId, null, sourceField, FieldDirection.SOURCE, validations);</span>
<span class="fc" id="L157">                });</span>
            }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        } else if (getMode() == AtlasModuleMode.TARGET) {</span>
<span class="fc" id="L160">            List&lt;Field&gt; targetFields = mapping.getOutputField();</span>

<span class="fc bfc" id="L162" title="All 4 branches covered.">            if (targetFields.size() == 1 &amp;&amp; Integer.valueOf(0).equals(targetFields.get(0).getIndex())) {</span>
                //The index should not have been set as there's only one item
<span class="fc" id="L164">                targetFields.get(0).setIndex(null);</span>
            }

<span class="fc" id="L167">            int i  = 0;</span>
<span class="fc" id="L168">            List&lt;Field&gt; sourceFields = mapping.getInputField();</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">            for (Field targetField: targetFields) {</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">                if (sourceFields.size() &gt; i) {</span>
<span class="fc" id="L171">                    validateField(mappingId, sourceFields.get(i), targetField, FieldDirection.TARGET, validations);</span>
                } else {
<span class="fc" id="L173">                    validateField(mappingId, null, targetField, FieldDirection.TARGET, validations);</span>
                }
<span class="fc" id="L175">                i++;</span>
<span class="fc" id="L176">            }</span>
        }

<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (getMode() == AtlasModuleMode.SOURCE) {</span>
<span class="fc" id="L180">            validateFieldCombinations(mapping, validations);</span>
        }
<span class="fc" id="L182">    }</span>

    protected void validateCustomMapping(CustomMapping mapping, List&lt;Validation&gt; validations) {
<span class="pc bpc" id="L185" title="2 of 4 branches missed.">        if (mapping.getClassName() == null || mapping.getClassName().isEmpty()) {</span>
<span class="nc" id="L186">            Validation v = new Validation();</span>
<span class="nc" id="L187">            v.setScope(ValidationScope.MAPPING);</span>
<span class="nc" id="L188">            v.setMessage(&quot;Class name must be specified for custom mapping&quot;);</span>
<span class="nc" id="L189">            v.setStatus(ValidationStatus.ERROR);</span>
<span class="nc" id="L190">            validations.add(v);</span>
        }
<span class="fc" id="L192">    }</span>

    protected void validateFieldGroup(String mappingId, FieldGroup fieldGroup, FieldDirection direction, List&lt;Validation&gt; validations) {
<span class="fc" id="L195">        fieldGroup.getField().forEach(f -&gt; {validateField(mappingId, null, f, direction, validations);});</span>
<span class="fc" id="L196">    }</span>

    protected void validateFieldCombinations(Mapping mapping, List&lt;Validation&gt; validations) {
<span class="fc" id="L199">        String mappingId = mapping.getId();</span>
<span class="fc" id="L200">        FieldGroup sourceFieldGroup = mapping.getInputFieldGroup();</span>
<span class="fc" id="L201">        List&lt;Field&gt; sourceFields = mapping.getInputField();</span>
<span class="fc" id="L202">        List&lt;Field&gt; targetFields = mapping.getOutputField();</span>
<span class="pc bpc" id="L203" title="2 of 6 branches missed.">        if (sourceFieldGroup != null || (sourceFields != null &amp;&amp; sourceFields.size() &gt; 1)) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">            if (targetFields.size() &gt; 1) {</span>
<span class="nc" id="L205">                Validation validation = new Validation();</span>
<span class="nc" id="L206">                validation.setScope(ValidationScope.MAPPING);</span>
<span class="nc" id="L207">                validation.setId(mappingId);</span>
<span class="nc" id="L208">                validation.setMessage(&quot;Multiple fields can not be selected on both of Source and Target&quot;);</span>
<span class="nc" id="L209">                validation.setStatus(ValidationStatus.ERROR);</span>
<span class="nc" id="L210">                validations.add(validation);</span>
            }
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (sourceFieldGroup != null) {</span>
<span class="fc" id="L213">                mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceFieldGroup, targetFields.get(0));</span>
            } else {
<span class="nc" id="L215">                mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceFields, targetFields.get(0));</span>
            }
<span class="pc bpc" id="L217" title="1 of 4 branches missed.">        } else if (targetFields != null &amp;&amp; targetFields.size() &gt; 1) {</span>
<span class="fc" id="L218">            mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceFields.get(0), targetFields);</span>
        } else {
<span class="fc" id="L220">            mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceFields.get(0), targetFields.get(0));</span>
        }
<span class="fc" id="L222">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    protected void validateField(String mappingId, Field sourceField, Field targetField, FieldDirection direction, List&lt;Validation&gt; validations) {
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        if (targetField == null) {</span>
<span class="nc" id="L227">            return;</span>
        }
<span class="fc bfc" id="L229" title="All 2 branches covered.">        if (direction == FieldDirection.TARGET) {</span>
<span class="fc" id="L230">            Integer sourceCollectionCount = null;</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (sourceField != null) {</span>
<span class="fc" id="L232">                sourceCollectionCount = collectionHelper.determineSourceCollectionCount(null, sourceField);</span>
            }

<span class="fc" id="L235">            Integer targetCollectionCount = collectionHelper.determineTargetCollectionCount(targetField);</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">            if (sourceCollectionCount != null) {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">                if (sourceCollectionCount &gt; targetCollectionCount) {</span>
<span class="fc" id="L239">                    Validation validation = new Validation();</span>
<span class="fc" id="L240">                    validation.setScope(ValidationScope.MAPPING);</span>
<span class="fc" id="L241">                    validation.setId(mappingId);</span>
<span class="fc" id="L242">                    String message = String.format(</span>
                        &quot;Target [%s] has %s collection(s) on the path, whereas source has %s. Values from the %s rightmost &quot; +
                            &quot;source collections on the path will be added in depth-first order to the rightmost target &quot; +
                            &quot;collection(s) unless transformed explicitly.&quot;,
<span class="fc" id="L246">                        targetField.getPath(), targetCollectionCount, sourceCollectionCount,</span>
<span class="fc" id="L247">                        sourceCollectionCount - targetCollectionCount + 1);</span>
<span class="fc" id="L248">                    validation.setMessage(message);</span>
<span class="fc" id="L249">                    validation.setStatus(ValidationStatus.WARN);</span>
<span class="fc" id="L250">                    validations.add(validation);</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">                } else if (sourceCollectionCount &lt; targetCollectionCount) {</span>
<span class="fc" id="L252">                    Validation validation = new Validation();</span>
<span class="fc" id="L253">                    validation.setScope(ValidationScope.MAPPING);</span>
<span class="fc" id="L254">                    validation.setId(mappingId);</span>
<span class="fc" id="L255">                    validation.setMessage(String.format(&quot;The 0 index will be used for any extra parent collections in &quot; +</span>
                            &quot;target [%s], since target has %s collections on the path, whereas source has %s.&quot;,
<span class="fc" id="L257">                        targetField.getPath(), targetCollectionCount, sourceCollectionCount));</span>
<span class="fc" id="L258">                    validation.setStatus(ValidationStatus.WARN);</span>
<span class="fc" id="L259">                    validations.add(validation);</span>
                }
            }

        }
<span class="fc bfc" id="L264" title="All 4 branches covered.">        if (getFieldType().isAssignableFrom(targetField.getClass()) &amp;&amp; matchDocIdOrNull(targetField.getDocId())) {</span>
<span class="fc" id="L265">            validateModuleField(mappingId, (T)targetField, direction, validations);</span>
        }
<span class="fc" id="L267">    }</span>

    protected abstract Class&lt;T&gt; getFieldType();

    protected abstract void validateModuleField(String mappingId, T field, FieldDirection direction, List&lt;Validation&gt; validation);

    protected boolean matchDocIdOrNull(String docId) {
<span class="fc bfc" id="L274" title="All 4 branches covered.">        return docId == null || getDocId().equals(docId);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    protected String getFieldName(Field field) {
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        if (field == null) {</span>
<span class="nc" id="L280">            return &quot;null&quot;;</span>
        }
<span class="fc bfc" id="L282" title="All 2 branches covered.">        if (field.getClass().isAssignableFrom(getFieldType())) {</span>
<span class="fc" id="L283">            return getModuleFieldName((T)field);</span>
        }
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        if (field.getFieldType() != null) {</span>
<span class="fc" id="L286">            return field.getFieldType().name();</span>
        }
<span class="nc" id="L288">        return field.getClass().getName();</span>
    }

    protected abstract String getModuleFieldName(T field);

    protected AtlasConversionService getConversionService() {
<span class="fc" id="L294">        return conversionService;</span>
    }

    protected AtlasFieldActionService getFieldActionService() {
<span class="fc" id="L298">        return fieldActionService;</span>
    }

    protected MappingFieldPairValidator getMappingFieldPairValidator() {
<span class="nc" id="L302">        return mappingFieldPairValidator;</span>
    }

    protected void setMappingFieldPairValidator(MappingFieldPairValidator mfpv) {
<span class="fc" id="L306">        mappingFieldPairValidator = mfpv;</span>
<span class="fc" id="L307">    }</span>

    protected void setConversionService(AtlasConversionService conversionService) {
<span class="nc" id="L310">        this.conversionService = conversionService;</span>
<span class="nc" id="L311">    }</span>

    /*
     * vvv Remove in 2.0 vvv
     */

    @Deprecated
    protected void validateCombineMapping(Mapping mapping, List&lt;Validation&gt; validations) {
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        if (mapping == null) {</span>
<span class="nc" id="L320">            return;</span>
        }

<span class="fc" id="L323">        List&lt;Field&gt; sourceFields = mapping.getInputField();</span>

<span class="fc" id="L325">        final List&lt;Field&gt; targetFields = mapping.getOutputField();</span>
<span class="pc bpc" id="L326" title="2 of 4 branches missed.">        final Field targetField = (targetFields != null &amp;&amp; !targetFields.isEmpty()) ? targetFields.get(0) : null;</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">        if (targetField == null) {</span>
<span class="nc" id="L328">            return;</span>
        }

<span class="fc" id="L331">        String mappingId = mapping.getId();</span>

<span class="pc bpc" id="L333" title="1 of 4 branches missed.">        if (getMode() == AtlasModuleMode.TARGET &amp;&amp; matchDocIdOrNull(targetField.getDocId())) {</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">            if (sourceFields != null) {</span>
                // FIXME Run only for TARGET to avoid duplicate validation...
                // we should convert per module validations to plugin style
<span class="fc bfc" id="L337" title="All 2 branches covered.">                for (Field sourceField : sourceFields) {</span>
<span class="fc" id="L338">                    mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceField, targetField);</span>
<span class="fc" id="L339">                }</span>
            }

            // check that the output field is of type String else error
<span class="pc bpc" id="L343" title="1 of 4 branches missed.">            if (targetField.getFieldType() != null &amp;&amp; targetField.getFieldType() != FieldType.STRING) {</span>
<span class="fc" id="L344">                Validation validation = new Validation();</span>
<span class="fc" id="L345">                validation.setScope(ValidationScope.MAPPING);</span>
<span class="fc" id="L346">                validation.setId(mappingId);</span>
<span class="fc" id="L347">                validation.setMessage(String.format(</span>
                        &quot;Target field '%s' must be of type '%s' for a Combine Mapping&quot;,
<span class="fc" id="L349">                        getFieldName(targetField), FieldType.STRING));</span>
<span class="fc" id="L350">                validation.setStatus(ValidationStatus.ERROR);</span>
<span class="fc" id="L351">                validations.add(validation);</span>
            }
<span class="fc" id="L353">            validateField(mappingId, null, targetField, FieldDirection.TARGET, validations);</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        } else if (sourceFields != null) { // SOURCE</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">            for (Field sourceField : sourceFields) {</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                if (matchDocIdOrNull(sourceField.getDocId())) {</span>
<span class="fc" id="L357">                    validateField(mappingId, null, sourceField, FieldDirection.SOURCE, validations);</span>
                }
<span class="fc" id="L359">            }</span>
        }
<span class="fc" id="L361">    }</span>

    @Deprecated
    protected void validateSeparateMapping(Mapping mapping, List&lt;Validation&gt; validations) {
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">        if (mapping == null) {</span>
<span class="nc" id="L366">            return;</span>
        }

<span class="fc" id="L369">        final List&lt;Field&gt; sourceFields = mapping.getInputField();</span>
<span class="pc bpc" id="L370" title="2 of 4 branches missed.">        final Field sourceField = (sourceFields != null &amp;&amp; !sourceFields.isEmpty()) ? sourceFields.get(0) : null;</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">        if (sourceField == null) {</span>
<span class="nc" id="L372">            return;</span>
        }
<span class="fc" id="L374">        List&lt;Field&gt; targetFields = mapping.getOutputField();</span>
<span class="fc" id="L375">        String mappingId = mapping.getId();</span>

<span class="pc bpc" id="L377" title="1 of 4 branches missed.">        if (getMode() == AtlasModuleMode.SOURCE &amp;&amp; matchDocIdOrNull(sourceField.getDocId())) {</span>
            // check that the source field is of type String else error
<span class="pc bpc" id="L379" title="1 of 4 branches missed.">            if (sourceField.getFieldType() != null &amp;&amp; sourceField.getFieldType() != FieldType.STRING) {</span>
<span class="fc" id="L380">                Validation validation = new Validation();</span>
<span class="fc" id="L381">                validation.setScope(ValidationScope.MAPPING);</span>
<span class="fc" id="L382">                validation.setId(mapping.getId());</span>
<span class="fc" id="L383">                validation.setMessage(String.format(</span>
                        &quot;Source field '%s' must be of type '%s' for a Separate Mapping&quot;,
<span class="fc" id="L385">                        getFieldName(sourceField), FieldType.STRING));</span>
<span class="fc" id="L386">                validation.setStatus(ValidationStatus.ERROR);</span>
<span class="fc" id="L387">                validations.add(validation);</span>
            }
<span class="fc" id="L389">            validateField(mappingId, null, sourceField, FieldDirection.SOURCE, validations);</span>

<span class="pc bpc" id="L391" title="1 of 2 branches missed.">            if (targetFields != null) {</span>
                // FIXME Run only for SOURCE to avoid duplicate validation...
                // we should convert per module validations to plugin style
<span class="fc bfc" id="L394" title="All 2 branches covered.">                for (Field targetField : targetFields) {</span>
<span class="fc" id="L395">                    mappingFieldPairValidator.validateFieldTypes(validations, mappingId, sourceField, targetField);</span>
<span class="fc" id="L396">                }</span>
            }
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">        } else if (targetFields != null) { // TARGET</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">            for (Field targetField : targetFields) {</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">                if (matchDocIdOrNull(targetField.getDocId())) {</span>
<span class="fc" id="L401">                    validateField(mappingId, null, targetField, FieldDirection.TARGET, validations);</span>
                }
<span class="fc" id="L403">            }</span>
        }
<span class="fc" id="L405">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>